<h2>Welcome, {{ email }}</h2>

<div class="grid kpis">
  <nb-card *ngFor="let s of stats" class="stat">
    <nb-card-header><nb-icon [icon]="s.icon"></nb-icon> {{ s.title }}</nb-card-header>
    <nb-card-body><h2>{{ s.value }}</h2></nb-card-body>
  </nb-card>
</div>

<nb-card>
  <nb-card-header style="display:flex;justify-content:space-between;align-items:center">
    <span>Live Alarms</span>
    <span class="chip" style="font-size:12px;padding:2px 8px;border-radius:10px;background:#eef;">10m</span>
  </nb-card-header>
  <nb-card-body>
    <div class="flex" style="gap:16px; align-items:center; margin-bottom:8px;">
      <strong>Toplam Aktif (son 10 dk):</strong>
      <span class="badge">
        {{ (totalActive$ | async) ?? 0 }}
      </span>
    </div>

<table class="table live" *ngIf="(recent$ | async) as recent; else empty">
  <colgroup>
    <col style="width:16%">
    <col style="width:14%">
    <col style="width:18%">
    <col style="width:30%">
    <col style="width:10%">
    <col style="width:12%">
  </colgroup>
  <thead>
    <tr>
      <th>Time</th>
      <th>System</th>
      <th>Point</th>
      <th>Location</th>
      <th>Level</th>
      <th>Message</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let e of recent | slice:0:5">
      <td>
        <span title="event: {{ e.timestamp | date:'short' }}">
          {{ (e.arrivedAt || e.createdAt || e.timestamp) | date:'short' }}
        </span>
      </td>
      <td class="truncate" [title]="e.system || '—'">{{ e.system || '—' }}</td>
      <td class="truncate" [title]="e.point || e.device || '—'">{{ e.point || e.device || '—' }}</td>
      <td class="truncate" [title]="e.location">{{ e.location }}</td>
      <td>
        <span [ngClass]="{
          'text-danger': e.level === 'CRITICAL',
          'text-warning': e.level === 'WARN',
          'text-info': e.level === 'INFO'
        }">{{ e.level }}</span>
      </td>
      <td class="truncate" [title]="e.message">{{ e.message }}</td>
    </tr>
  </tbody>
</table>

    <ng-template #empty>
      <em>Bağlantı bekleniyor…</em>
    </ng-template>
  </nb-card-body>
</nb-card>

<nb-card>
  <nb-card-header>Weekly Alarms</nb-card-header>
  <nb-card-body>
    <div #trendEl class="echart"></div>
  </nb-card-body>
</nb-card>

<div class="grid charts-2">
  <nb-card>
    <nb-card-header style="display:flex;justify-content:space-between;align-items:center">
      <span>Severity Distribution</span>
      <!-- 10m doluysa 10m, boşsa 1h -->
        <span class="chip" style="font-size:12px;padding:2px 8px;border-radius:10px;background:#eef;">
    {{ sevPieLabel }}
  </span>
    </nb-card-header>
    <nb-card-body>
      <div #pieEl class="echart"></div>
    </nb-card-body>
  </nb-card>

  <nb-card>
    <nb-card-header style="display:flex;justify-content:space-between;align-items:center">
      <span>Hourly Activity</span>
      <span class="chip" style="font-size:12px;padding:2px 8px;border-radius:10px;background:#eef;">12h</span>
    </nb-card-header>
    <nb-card-body>
      <div #barEl class="echart"></div>
    </nb-card-body>
  </nb-card>
</div>

<div class="grid charts-2">
  <nb-card>
    <nb-card-header>System Uptime</nb-card-header>
    <nb-card-body>
      <div #gaugeEl class="echart small"></div>
    </nb-card-body>
  </nb-card>

  <nb-card>
    <nb-card-header>Recent Events</nb-card-header>
    <nb-card-body>
      <table class="table">
        <thead>
          <tr><th>Time</th><th>Source</th><th>Message</th></tr>
        </thead>
        <tbody>
          <tr><td>09:12</td><td>Tunnel-2</td><td>Warning acknowledged</td></tr>
          <tr><td>08:45</td><td>Tunnel-4</td><td>Info received</td></tr>
          <tr><td>Yesterday</td><td>Tunnel-1</td><td>Critical resolved</td></tr>
        </tbody>
      </table>
    </nb-card-body>
  </nb-card>
</div>